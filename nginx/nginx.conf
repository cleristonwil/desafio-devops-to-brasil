# Zona de cache para App 1 — expira em 10 segundos
proxy_cache_path /var/cache/nginx/app1
    levels=1:2
    keys_zone=cache_app1:10m
    max_size=100m
    inactive=10s
    use_temp_path=off;

# Zona de cache para App 2 — expira em 1 minuto
proxy_cache_path /var/cache/nginx/app2
    levels=1:2
    keys_zone=cache_app2:10m
    max_size=100m
    inactive=60s
    use_temp_path=off;

upstream app1 {
    server app1:5000;
}

upstream app2 {
    server app2:3000;
}

server {
    listen 80;
    server_name localhost;

    # Endpoint de status para o Prometheus coletar métricas
    location /nginx_status {
        stub_status on;
        allow 172.0.0.0/8;
        deny all;
    }

    # Rotas da App 1 — cache de 10 segundos
    location /app1/ {
        proxy_pass http://app1/;
        proxy_cache cache_app1;
        proxy_cache_valid 200 10s;
        proxy_cache_use_stale error timeout updating;
        proxy_cache_lock on;
        add_header X-Cache-Status $upstream_cache_status;
        add_header X-App "App1-Python";
    }

    # Rotas da App 2 — cache de 1 minuto
    location /app2/ {
        proxy_pass http://app2/;
        proxy_cache cache_app2;
        proxy_cache_valid 200 60s;
        proxy_cache_use_stale error timeout updating;
        proxy_cache_lock on;
        add_header X-Cache-Status $upstream_cache_status;
        add_header X-App "App2-Node";
    }

    # Health check
    location /health {
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}